# CS2 Forecasting System

## Описание системы

Система предназначена для **прогноза исходов матчей CS2**, использует **микросервисную архитектуру**, **машинное обучение**, **асинхронный обмен событиями через Redis** и хранение данных в PostgreSQL и MongoDB.  

Основные функции:

- Регистрация и аутентификация пользователей
- Работа со справочниками (карты, команды, игроки)
- Хранение и обновление ML моделей
- Прогнозирование вероятностей побед
- Сбор и хранение истории прогнозов
- Постоянное обновление данных и моделей через демоны ETL и ML

---

## Сервисы системы

### 1. Auth
**Назначение:** управление пользователями и аутентификацией.  

- **Миграции**: `001_create_users_table.sql` — создание таблицы пользователей.  
- **Repositories** (`user.py`) — CRUD операции с пользователями.  
- **Services** (`auth.py`) — логика аутентификации, хэширование паролей, JWT-токены.  
- **Routers** (`auth.py`) — эндпоинты для регистрации, логина, получения информации о пользователе.  

**Технологии:** PostgreSQL, JWT, FastAPI.

---

### 2. Dictionaries
**Назначение:** управление справочниками для матчей.  

- **Миграции**: создают таблицы `maps`, `teams`, `players`.  
- **Repositories** (`map.py`, `team.py`, `player.py`) — доступ к данным PostgreSQL.  
- **Routers** (`map.py`, `team.py`, `player.py`) — API для получения справочной информации.  

Используется для проверки корректности входных данных при прогнозировании.

---

### 3. ETL (демон)
**Назначение:** извлечение, трансформация и загрузка данных для моделей.  

- Работает как **фоновый сервис (демон)**, непрерывно обновляет данные матчей и игроков.  
- Скрипты в `etl/etl.py` и `etl/main.py` выполняют подготовку и очистку данных.  
- Обновленные данные сохраняются в PostgreSQL для использования ML сервисом.  

**Технологии:** Python, Pandas, PostgreSQL, AsyncIO.

---

### 4. ML (демон)
**Назначение:** обучение моделей и генерация предсказаний.  

- Работает как **фоновый сервис (демон)**, отслеживает новые данные, обучает новые модели и сохраняет их в PostgreSQL.  
- `data_loader.py` — загрузка исходных данных матчей.  
- `feature_extractors.py` — формирование признаков для ML моделей.  
- `predictor.py` — класс предсказания исхода на основе обученной модели.  
- `metrics.py` — подсчет метрик качества модели.  
- Новые модели публикуются в Redis канал `"ml_models"` для Forecaster.  

**Технологии:** scikit-learn, joblib, numpy, pandas, AsyncIO.

---

### 5. Forecaster
**Назначение:** предоставление API прогнозов матчей.  

- **Repositories**: `MLResultsRepository` — хранение информации о ML моделях.  
- **Routers**: `/forecast/get_team1_win_probability` — endpoint для запроса вероятности победы команды.  
- **Логика работы**:
  1. Загружает актуальную модель в память при старте (`app.state.predictor`).  
  2. Подписан на Redis канал `"ml_models"` для получения уведомлений о новых моделях.  
  3. При запросе формирует признаки (map_id, команды, игроки) и возвращает вероятность победы.  
  4. Публикует событие прогноза в Redis канал `"forecast_events"`.  

**Технологии:** FastAPI, Redis, Joblib, AsyncIO.

---

### 6. Forecast_results
**Назначение:** сохранение результатов прогнозов.  

- Подписан на Redis канал `"forecast_events"`.  
- Получает события прогнозов (request + response) и сохраняет их в MongoDB.  
- Позволяет анализировать историю прогнозов, строить отчеты и переобучать модели.  

**Технологии:** MongoDB, Redis, AsyncIO.

---

## Логика работы системы

1. **Регистрация и аутентификация**
   - Пользователь регистрируется через `auth` API.
   - Получает JWT-токен для доступа к защищённым эндпоинтам.
   
2. **Обновление данных**
   - ETL демон непрерывно обновляет данные матчей и игроков в PostgreSQL.

3. **Обучение модели**
   - ML демон периодически обучает новые модели на свежих данных.
   - Новые модели сохраняются в PostgreSQL и публикуются в Redis.

4. **Прогноз матча**
   - Пользователь делает POST-запрос на `/forecast/get_team1_win_probability`.
   - Endpoint использует актуальную модель из памяти.
   - Формирует признаки (`map_id`, команды, игроки).
   - Делает предсказание вероятностей побед.
   - Публикует событие прогноза в Redis.

5. **Сбор истории прогнозов**
   - Микросервис `forecast_results` сохраняет события прогнозов в MongoDB.
   - История используется для анализа и переобучения моделей.

6. **Справочники**
   - Проверка корректности входных данных (карты, команды, игроки).
   - API роутеры позволяют клиентам получать актуальные данные.

---

## Технологии

- **Python 3.11**, FastAPI, AsyncIO
- **PostgreSQL** — справочники и ML модели
- **MongoDB** — история прогнозов
- **Redis** — pub/sub события
- **Joblib** — сериализация ML моделей
- **JWT** — аутентификация пользователей
- **Микросервисная архитектура** — отдельные сервисы: auth, dictionaries, etl (демон), ml (демон), forecaster, forecast_results
